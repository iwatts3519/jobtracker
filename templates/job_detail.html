{% extends "base.html" %}

{% block title %}{{ job.title or 'Job Details' }} - Job Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Job Details</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>{{ job.title or 'Untitled Job' }}</h2>
                <span class="badge bg-{{ 'secondary' if job.status == 'saved' else 'warning' if job.status == 'applied' else 'info' if job.status == 'interview' else 'success' }} fs-6">
                    {{ job.status.title() }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Company:</strong></div>
                    <div class="col-sm-9">{{ job.company or 'Not specified' }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Location:</strong></div>
                    <div class="col-sm-9">{{ job.location or 'Not specified' }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Job URL:</strong></div>
                    <div class="col-sm-9">
                        <a href="{{ job.url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 400px;">
                            {{ job.url }}
                            <i class="fas fa-external-link-alt ms-1"></i>
                        </a>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Date Added:</strong></div>
                    <div class="col-sm-9">{{ job.date_added.strftime('%B %d, %Y at %I:%M %p') }}</div>
                </div>
                
                {% if job.date_applied %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Date Applied:</strong></div>
                    <div class="col-sm-9">{{ job.date_applied.strftime('%B %d, %Y at %I:%M %p') }}</div>
                </div>
                {% endif %}
                
                {% if job.salary_range %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Salary Range:</strong></div>
                    <div class="col-sm-9">{{ job.salary_range }}</div>
                </div>
                {% endif %}
                
                {% if job.job_type %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Job Type:</strong></div>
                    <div class="col-sm-9">{{ job.job_type }}</div>
                </div>
                {% endif %}
                
                {% if job.description %}
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Job Description:</strong>
                        <div class="mt-2 p-3 bg-light rounded">
                            <div class="job-description">{{ job.description|replace('\n', '<br>')|safe }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="window.open('{{ job.url }}', '_blank')">
                        <i class="fas fa-external-link-alt me-2"></i>View Original Posting
                    </button>
                    
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cvModal">
                        <i class="fas fa-robot me-2"></i>Customize CV
                    </button>
                    
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#coverLetterModal">
                        <i class="fas fa-envelope me-2"></i>Generate Cover Letter
                    </button>
                    
                    <a class="btn btn-warning" href="{{ url_for('research_company', job_id=job.id) }}">
                        <i class="fas fa-search me-2"></i>Research Company
                    </a>
                    
                    <button class="btn btn-secondary" onclick="scrapeJobDetails()">
                        <i class="fas fa-sync me-2"></i>Auto-fill Details
                    </button>
                    
                    <hr>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-edit me-2"></i>Change Status
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item change-status" data-status="saved" href="#">
                                <i class="fas fa-bookmark me-2"></i>Saved
                            </a></li>
                            <li><a class="dropdown-item change-status" data-status="applied" href="#">
                                <i class="fas fa-paper-plane me-2"></i>Applied
                            </a></li>
                            <li><a class="dropdown-item change-status" data-status="interview" href="#">
                                <i class="fas fa-handshake me-2"></i>Interview
                            </a></li>
                            <li><a class="dropdown-item change-status" data-status="offered" href="#">
                                <i class="fas fa-trophy me-2"></i>Offered
                            </a></li>
                        </ul>
                    </div>
                    
                    <hr>
                    
                    <form method="POST" action="{{ url_for('delete_job', job_id=job.id) }}" 
                          onsubmit="return confirm('Are you sure you want to delete this job?')">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Delete Job
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-chart-line me-2"></i>Quick Stats</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <div>Status: <strong>{{ job.status.title() }}</strong></div>
                    <div>Days since added: <strong>{{ (moment().utcnow() - job.date_added).days if moment else 'N/A' }}</strong></div>
                    {% if job.date_applied %}
                    <div>Days since applied: <strong>{{ (moment().utcnow() - job.date_applied).days if moment else 'N/A' }}</strong></div>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- CV Customization Modal -->
<div class="modal fade" id="cvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Customize CV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('customize_cv', job_id=job.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cv_selector" class="form-label">Select Uploaded CV</label>
                        <select class="form-select" id="cv_selector" onchange="loadSelectedCV()">
                            <option value="">Choose from uploaded CVs...</option>
                        </select>
                        <div class="form-text">Select a previously uploaded CV or <a href="{{ url_for('cv_customizer') }}" target="_blank">upload a new one</a>.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cv_text" class="form-label">CV Content</label>
                        <textarea class="form-control" id="cv_text" name="cv_text" rows="10" 
                                  placeholder="Select a CV above or paste your CV content here..." required></textarea>
                        <div class="form-text">
                            <span class="badge bg-info" id="cv_status">No CV selected</span>
                        </div>
                    </div>
                    
                    {% if not job.description %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No job description available. For better results, try auto-filling job details first.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-robot me-2"></i>Customize CV
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cover Letter Modal -->
<div class="modal fade" id="coverLetterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Generate Cover Letter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('generate_cover_letter', job_id=job.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cover_cv_selector" class="form-label">Select Uploaded CV</label>
                        <select class="form-select" id="cover_cv_selector" onchange="loadSelectedCVForCover()">
                            <option value="">Choose from uploaded CVs...</option>
                        </select>
                        <div class="form-text">Select a previously uploaded CV or <a href="{{ url_for('cv_customizer') }}" target="_blank">upload a new one</a>.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cover_cv_text" class="form-label">CV Content</label>
                        <textarea class="form-control" id="cover_cv_text" name="cv_text" rows="8" 
                                  placeholder="Select a CV above or paste your CV content here..." required></textarea>
                        <div class="form-text">
                            <span class="badge bg-info" id="cover_cv_status">No CV selected</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_name" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="user_name" name="user_name" 
                               placeholder="John Smith" required>
                        <div class="form-text">This will be used in the cover letter greeting.</div>
                    </div>
                    
                    {% if not job.description %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No job description available. For better results, try auto-filling job details first.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-envelope me-2"></i>Generate Cover Letter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('.change-status').click(function(e) {
        e.preventDefault();
        var newStatus = $(this).data('status');
        
        $.ajax({
            url: '{{ url_for("update_job_status") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                'job_id': {{ job.id }},
                'status': newStatus
            }),
            success: function(response) {
                if (response.success) {
                    location.reload();
                }
            },
            error: function() {
                alert('Failed to update job status. Please try again.');
            }
        });
    });
    
    // Load CV list when modals are opened
    $('#cvModal').on('shown.bs.modal', function() {
        loadCVList('cv_selector');
    });
    
    $('#coverLetterModal').on('shown.bs.modal', function() {
        loadCVList('cover_cv_selector');
    });
});

function loadCVList(selectorId) {
    $.ajax({
        url: '{{ url_for("get_cv_list") }}',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                var selector = $('#' + selectorId);
                selector.empty();
                selector.append('<option value="">Choose from uploaded CVs...</option>');
                
                if (response.cvs.length === 0) {
                    selector.append('<option value="" disabled>No CVs uploaded yet</option>');
                } else {
                    response.cvs.forEach(function(cv) {
                        selector.append('<option value="' + cv.filename + '">' + cv.display_name + '</option>');
                    });
                }
            }
        },
        error: function() {
            console.error('Failed to load CV list');
        }
    });
}

function loadSelectedCV() {
    var filename = $('#cv_selector').val();
    if (!filename) {
        $('#cv_text').val('');
        $('#cv_status').text('No CV selected').removeClass('bg-success').addClass('bg-info');
        return;
    }
    
    $('#cv_status').text('Loading CV...').removeClass('bg-success bg-danger').addClass('bg-warning');
    
    $.ajax({
        url: '{{ url_for("get_cv_text", filename="") }}' + filename,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#cv_text').val(response.cv_text);
                $('#cv_status').text('CV loaded successfully').removeClass('bg-warning bg-info').addClass('bg-success');
            } else {
                $('#cv_status').text('Failed to load CV').removeClass('bg-warning bg-success').addClass('bg-danger');
                alert('Failed to load CV: ' + response.error);
            }
        },
        error: function() {
            $('#cv_status').text('Error loading CV').removeClass('bg-warning bg-success').addClass('bg-danger');
            alert('Failed to load CV content. Please try again.');
        }
    });
}

function loadSelectedCVForCover() {
    var filename = $('#cover_cv_selector').val();
    if (!filename) {
        $('#cover_cv_text').val('');
        $('#cover_cv_status').text('No CV selected').removeClass('bg-success').addClass('bg-info');
        return;
    }
    
    $('#cover_cv_status').text('Loading CV...').removeClass('bg-success bg-danger').addClass('bg-warning');
    
    $.ajax({
        url: '{{ url_for("get_cv_text", filename="") }}' + filename,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#cover_cv_text').val(response.cv_text);
                $('#cover_cv_status').text('CV loaded successfully').removeClass('bg-warning bg-info').addClass('bg-success');
            } else {
                $('#cover_cv_status').text('Failed to load CV').removeClass('bg-warning bg-success').addClass('bg-danger');
                alert('Failed to load CV: ' + response.error);
            }
        },
        error: function() {
            $('#cover_cv_status').text('Error loading CV').removeClass('bg-warning bg-success').addClass('bg-danger');
            alert('Failed to load CV content. Please try again.');
        }
    });
}

function scrapeJobDetails() {
    var btn = event.target;
    var originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scraping...';
    btn.disabled = true;
    
    $.ajax({
        url: '{{ url_for("scrape_job_url") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            'url': '{{ job.url }}'
        }),
        success: function(response) {
            if (response.success && response.job_info) {
                // Update job details on page if any were found
                var info = response.job_info;
                if (info.title) {
                    $('.card-header h2').text(info.title);
                }
                if (info.company) {
                    $('div:contains("Company:")').next().text(info.company);
                }
                if (info.location) {
                    $('div:contains("Location:")').next().text(info.location);
                }
                if (info.description) {
                    $('.job-description').html(info.description.replace(/\n/g, '<br>'));
                }
                alert('Job details updated! Refresh the page to see changes in the database.');
            } else {
                alert('Could not extract job details: ' + (response.error || 'Unknown error'));
            }
        },
        error: function() {
            alert('Failed to scrape job details. Please try again.');
        },
        complete: function() {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
}
</script>
{% endblock %}